<!--
	NOTE: You need to build the notes plugin after making changes to this file.
-->
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>reveal.js - Speaker View</title>

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        font-size: 16px;
        margin: 0;
        padding: 0;
        background: #1a1a1a;
        color: #e0e0e0;
      }

      #current-slide,
      #upcoming-slide,
      #speaker-controls {
        padding: 8px;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        overflow: hidden;
      }

      #current-slide iframe,
      #upcoming-slide iframe {
        width: 100%;
        height: 100%;
        border: 2px solid #3a3a3a;
        border-radius: 8px;
        background: #000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        transform-origin: 0 0;
      }

      #current-slide .label,
      #upcoming-slide .label {
        position: absolute;
        top: 16px;
        left: 16px;
        z-index: 2;
        font-weight: 600;
        font-size: 8px;
        letter-spacing: 0.5px;
      }

      #connection-status {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 20;
        padding: 30% 20% 20% 20%;
        font-size: 18px;
        color: #222;
        background: #fff;
        text-align: center;
        box-sizing: border-box;
        line-height: 1.4;
      }

      .overlay-element {
        height: 22px;
        line-height: 22px;
        padding: 0 8px;
        text-shadow: none;
        background: rgba(80, 80, 200, 0.85);
        color: #fff;
        font-size: 9px;
        font-weight: 600;
        border-radius: 3px;
        backdrop-filter: blur(10px);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .overlay-element.interactive:hover {
        background: rgba(90, 90, 220, 1);
        cursor: pointer;
      }

      /* Default layout */
      #current-slide {
        position: absolute;
        width: 58%;
        height: 100%;
        top: 0;
        left: 0;
        padding-right: 0;
      }

      #upcoming-slide {
        position: absolute;
        width: 42%;
        height: 30%;
        right: 0;
        top: 0;
      }

      /* Speaker controls */
      #speaker-controls {
        position: absolute;
        top: 30%;
        right: 0;
        width: 42%;
        height: 70%;
        overflow: hidden;
        font-size: 15px;
        background: #252525;
        border-left: 2px solid #3a3a3a;
        padding: 16px;
        display: flex;
        flex-direction: column;
      }

      .speaker-controls-settings {
        background: #2a2a2a;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 12px;
        flex-shrink: 0;
      }

      .speaker-controls-settings .section-title {
        text-transform: uppercase;
        font-weight: 700;
        font-size: 11px;
        color: #888;
        margin: 0 0 12px 0;
        letter-spacing: 1px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(80, 80, 80, 0.5);
      }

      .speaker-controls-settings .subsection {
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(60, 60, 60, 0.3);
      }

      .speaker-controls-settings .subsection:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .speaker-controls-settings .subsection-label {
        text-transform: uppercase;
        font-weight: 600;
        font-size: 10px;
        color: #999;
        margin: 0 0 8px 0;
        letter-spacing: 0.5px;
        display: flex;
        justify-content: space-between;
      }

      .speaker-controls-settings .subsection-label .reset-button {
        cursor: pointer;
        color: #4a9eff;
        transition: color 0.2s;
      }

      .speaker-controls-settings .subsection-label .reset-button:hover {
        color: #6bb3ff;
        /* text-decoration: underline; */
      }

      .speaker-controls-time.hidden,
      .speaker-controls-notes.hidden {
        display: none;
      }

      .speaker-controls-time .label,
      .speaker-controls-pace .label,
      .speaker-controls-notes .label {
        text-transform: uppercase;
        font-weight: 700;
        font-size: 11px;
        color: #888;
        margin: 0 0 8px 0;
        letter-spacing: 1px;
      }

      .speaker-controls-settings .subsection-label .start-stop-button,
      .speaker-controls-settings .subsection-label .reset-button {
        color: #fff;
        text-decoration: none;
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 4px;
        transition: all 0.2s;
        cursor: pointer;
        margin-left: 8px;
        display: inline-block;
      }

      .speaker-controls-settings .subsection-label .start-stop-button {
        background: #4a9eff;
      }

      .speaker-controls-settings .subsection-label .start-stop-button:hover {
        background: #6bb3ff;
      }

      .speaker-controls-settings .subsection-label .start-stop-button.running {
        background: #8b5cf6;
      }

      .speaker-controls-settings
        .subsection-label
        .start-stop-button.running:hover {
        background: #7c3aed;
      }

      .speaker-controls-settings .subsection-label .start-stop-button.stopped {
        background: #10b981;
      }

      .speaker-controls-settings
        .subsection-label
        .start-stop-button.stopped:hover {
        background: #059669;
      }

      .speaker-controls-settings .subsection-label .reset-button {
        background: #ef4444;
      }

      .speaker-controls-settings .subsection-label .reset-button:hover {
        background: #dc2626;
      }

      .speaker-controls-time .timer,
      .speaker-controls-time .clock {
        width: 50%;
        display: inline-block;
        vertical-align: top;
      }

      .speaker-controls-time .timer,
      .speaker-controls-time .clock,
      .speaker-controls-time .pacing .hours-value,
      .speaker-controls-time .pacing .minutes-value,
      .speaker-controls-time .pacing .seconds-value {
        font-size: 2em;
        font-weight: 600;
        font-variant-numeric: tabular-nums;
      }

      .speaker-controls-time .timer {
        color: #ef4444;
      }

      .speaker-controls-time .clock {
        color: #3b82f6;
      }

      .speaker-controls-time span.mute {
        opacity: 0.3;
      }

      .speaker-controls-settings .layout-selector {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .speaker-controls-settings .layout-selector select {
        flex: 1;
        background: #3a3a3a;
        color: #e0e0e0;
        border: 1px solid #4a4a4a;
        border-radius: 4px;
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
        outline: none;
      }

      .speaker-controls-settings .layout-selector select:hover {
        background: #4a4a4a;
        border-color: #5a5a5a;
      }

      .speaker-controls-time .pacing-title {
        margin-top: 8px;
        font-size: 12px;
        color: #888;
      }

      .speaker-controls-time .pacing.ahead {
        color: #60a5fa;
      }

      .speaker-controls-time .pacing.on-track {
        color: #4ade80;
      }

      .speaker-controls-time .pacing.behind {
        color: #f87171;
      }

      .speaker-controls-notes {
        padding: 16px;
        background: #2a2a2a;
        border-radius: 8px;
        margin-top: 0;
        overflow-y: auto;
        overflow-x: hidden;
        word-wrap: break-word;
        flex: 1;
        min-height: 0;
      }

      .speaker-controls-notes .value {
        margin-top: 8px;
        line-height: 1.6;
        font-size: 14px;
        color: #e0e0e0;
      }

      .speaker-controls-notes .value ul {
        margin: 8px 0;
        padding-left: 20px;
      }

      .speaker-controls-notes .value li {
        margin: 6px 0;
        line-height: 1.5;
      }

      /* Layout selector */
      #speaker-layout {
        display: none;
        position: absolute;
        top: 12px;
        right: 12px;
        color: #fff;
        z-index: 10;
      }
      #speaker-layout select {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        border: 0;
        box-shadow: 0;
        cursor: pointer;
        opacity: 0;

        font-size: 1em;
        background-color: transparent;

        -moz-appearance: none;
        -webkit-appearance: none;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      }

      #speaker-layout select:focus {
        outline: none;
        box-shadow: none;
      }

      .clear {
        clear: both;
      }

      /* Scrollbar styling */
      #speaker-controls::-webkit-scrollbar,
      .speaker-controls-notes::-webkit-scrollbar {
        width: 8px;
      }

      #speaker-controls::-webkit-scrollbar-track,
      .speaker-controls-notes::-webkit-scrollbar-track {
        background: #1a1a1a;
        border-radius: 4px;
      }

      #speaker-controls::-webkit-scrollbar-thumb,
      .speaker-controls-notes::-webkit-scrollbar-thumb {
        background: #4a4a4a;
        border-radius: 4px;
      }

      #speaker-controls::-webkit-scrollbar-thumb:hover,
      .speaker-controls-notes::-webkit-scrollbar-thumb:hover {
        background: #5a5a5a;
      }

      /* Speaker layout: Wide - Optimized for content-heavy slides */
      body[data-speaker-layout='wide'] #current-slide,
      body[data-speaker-layout='wide'] #upcoming-slide {
        width: 50%;
        height: 50%;
        padding: 8px;
      }

      body[data-speaker-layout='wide'] #current-slide {
        top: 0;
        left: 0;
      }

      body[data-speaker-layout='wide'] #upcoming-slide {
        top: 0;
        left: 50%;
      }

      body[data-speaker-layout='wide'] #speaker-controls {
        top: 50%;
        left: 0;
        width: 100%;
        height: 50%;
        font-size: 14px;
        border-left: none;
        border-top: 2px solid #3a3a3a;
        padding: 16px;
        display: flex;
        flex-direction: row;
        gap: 16px;
        align-items: stretch;
        overflow: hidden;
      }

      body[data-speaker-layout='wide'] .speaker-controls-settings {
        margin-bottom: 0;
        flex: 0 0 320px;
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: visible;
      }

      body[data-speaker-layout='wide'] .speaker-controls-time .timer,
      body[data-speaker-layout='wide'] .speaker-controls-time .clock {
        width: 50%;
        display: inline-block;
        margin-bottom: 0;
      }

      body[data-speaker-layout='wide'] .speaker-controls-notes {
        margin-top: 0;
        flex: 1;
        height: 100%;
        overflow-y: auto;
      }

      /* Speaker layout: Tall - Focus on notes */
      body[data-speaker-layout='tall'] #current-slide,
      body[data-speaker-layout='tall'] #upcoming-slide {
        width: 40%;
        height: 48%;
        padding: 8px;
      }

      body[data-speaker-layout='tall'] #current-slide {
        top: 0;
        left: 0;
      }

      body[data-speaker-layout='tall'] #upcoming-slide {
        top: 52%;
        left: 0;
      }

      body[data-speaker-layout='tall'] #speaker-controls {
        padding-top: 20px;
        top: 0;
        left: 40%;
        width: 60%;
        height: 100%;
        font-size: 15px;
      }

      body[data-speaker-layout='tall'] .speaker-controls-notes {
        max-height: calc(100% - 220px);
      }

      /* Speaker layout: Notes only */
      body[data-speaker-layout='notes-only'] #current-slide,
      body[data-speaker-layout='notes-only'] #upcoming-slide {
        display: none;
      }

      body[data-speaker-layout='notes-only'] #speaker-controls {
        padding-top: 40px;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        font-size: 18px;
        border-left: none;
      }

      body[data-speaker-layout='notes-only'] .speaker-controls-notes {
        max-height: calc(100% - 220px);
        font-size: 16px;
      }

      @media screen and (max-width: 1080px) {
        body[data-speaker-layout='default'] #speaker-controls {
          font-size: 14px;
        }
        .speaker-controls-time .timer,
        .speaker-controls-time .clock {
          font-size: 1.8em;
        }
      }

      @media screen and (max-width: 900px) {
        body[data-speaker-layout='default'] #speaker-controls {
          font-size: 13px;
        }
        .speaker-controls-time .timer,
        .speaker-controls-time .clock {
          font-size: 1.6em;
        }
      }

      @media screen and (max-width: 800px) {
        body[data-speaker-layout='default'] #speaker-controls {
          font-size: 12px;
        }
        .speaker-controls-time .timer,
        .speaker-controls-time .clock {
          font-size: 1.4em;
        }
      }
    </style>
  </head>

  <body>
    <div id="connection-status">Loading speaker view...</div>

    <div id="current-slide">
      <span class="overlay-element label">Current</span>
    </div>
    <div id="upcoming-slide">
      <span class="overlay-element label">Upcoming</span>
    </div>
    <div id="speaker-controls">
      <div class="speaker-controls-settings">
        <h4 class="section-title">Settings</h4>

        <div class="subsection">
          <h5 class="subsection-label">
            Time
            <span>
              <span class="start-stop-button">Start</span>
              <span class="reset-button">Reset</span>
            </span>
          </h5>
          <div class="speaker-controls-time">
            <div class="clock">
              <span class="clock-value">0:00 AM</span>
            </div>
            <div class="timer">
              <span class="hours-value">00</span
              ><span class="minutes-value">:00</span
              ><span class="seconds-value">:00</span>
            </div>
            <div class="clear"></div>

            <h4 class="label pacing-title" style="display: none">
              Pacing – Time to finish current slide
            </h4>
            <div class="pacing" style="display: none">
              <span class="hours-value">00</span
              ><span class="minutes-value">:00</span
              ><span class="seconds-value">:00</span>
            </div>
          </div>
        </div>

        <div class="subsection">
          <h5 class="subsection-label">Layout</h5>
          <div class="layout-selector">
            <select class="speaker-layout-dropdown"></select>
          </div>
        </div>
      </div>

      <div class="speaker-controls-notes hidden">
        <h4 class="label">Notes</h4>
        <div class="value"></div>
      </div>
    </div>
    <div id="speaker-layout" class="overlay-element interactive">
      <span class="speaker-layout-label"></span>
      <select class="speaker-layout-dropdown"></select>
    </div>

    <script>
      (function () {
        var notes,
          notesValue,
          currentState,
          currentSlide,
          upcomingSlide,
          layoutLabel,
          layoutDropdown,
          pendingCalls = {},
          lastRevealApiCallId = 0,
          connected = false;

        var connectionStatus = document.querySelector('#connection-status');

        var SPEAKER_LAYOUTS = {
          default: 'Default',
          wide: 'Wide',
          tall: 'Tall',
          'notes-only': 'Notes only',
        };

        setupLayout();

        let openerOrigin;

        try {
          openerOrigin = window.opener.location.origin;
        } catch (error) {
          console.warn(error);
        }

        // In order to prevent XSS, the speaker view will only run if its
        // opener has the same origin as itself
        if (window.location.origin !== openerOrigin) {
          connectionStatus.innerHTML =
            'Cross origin error.<br>The speaker window can only be opened from the same origin.';
          return;
        }

        var connectionTimeout = setTimeout(function () {
          connectionStatus.innerHTML =
            'Error connecting to main window.<br>Please try closing and reopening the speaker view.';
        }, 5000);

        window.addEventListener('message', function (event) {
          clearTimeout(connectionTimeout);
          connectionStatus.style.display = 'none';

          var data = JSON.parse(event.data);

          // The overview mode is only useful to the reveal.js instance
          // where navigation occurs so we don't sync it
          if (data.state) delete data.state.overview;

          // Messages sent by the notes plugin inside of the main window
          if (data && data.namespace === 'reveal-notes') {
            if (data.type === 'connect') {
              handleConnectMessage(data);
            } else if (data.type === 'state') {
              handleStateMessage(data);
            } else if (data.type === 'return') {
              pendingCalls[data.callId](data.result);
              delete pendingCalls[data.callId];
            }
          }
          // Messages sent by the reveal.js inside of the current slide preview
          else if (data && data.namespace === 'reveal') {
            if (/ready/.test(data.eventName)) {
              // Send a message back to notify that the handshake is complete
              window.opener.postMessage(
                JSON.stringify({
                  namespace: 'reveal-notes',
                  type: 'connected',
                }),
                '*'
              );
            } else if (
              /slidechanged|fragmentshown|fragmenthidden|paused|resumed/.test(
                data.eventName
              ) &&
              currentState !== JSON.stringify(data.state)
            ) {
              dispatchStateToMainWindow(data.state);
            }
          }
        });

        /**
         * Updates the presentation in the main window to match the state
         * of the presentation in the notes window.
         */
        const dispatchStateToMainWindow = debounce((state) => {
          window.opener.postMessage(
            JSON.stringify({ method: 'setState', args: [state] }),
            '*'
          );
        }, 500);

        /**
         * Asynchronously calls the Reveal.js API of the main frame.
         */
        function callRevealApi(methodName, methodArguments, callback) {
          var callId = ++lastRevealApiCallId;
          pendingCalls[callId] = callback;
          window.opener.postMessage(
            JSON.stringify({
              namespace: 'reveal-notes',
              type: 'call',
              callId: callId,
              methodName: methodName,
              arguments: methodArguments,
            }),
            '*'
          );
        }

        /**
         * Called when the main window is trying to establish a
         * connection.
         */
        function handleConnectMessage(data) {
          if (connected === false) {
            connected = true;

            setupIframes(data);
            setupKeyboard();
            setupNotes();
            setupTimer();
            setupHeartbeat();
          }
        }

        /**
         * Called when the main window sends an updated state.
         */
        function handleStateMessage(data) {
          // Store the most recently set state to avoid circular loops
          // applying the same state
          currentState = JSON.stringify(data.state);

          // No need for updating the notes in case of fragment changes
          if (data.notes) {
            notes.classList.remove('hidden');
            notesValue.style.whiteSpace = data.whitespace;
            if (data.markdown) {
              notesValue.innerHTML = marked(data.notes);
            } else {
              notesValue.innerHTML = data.notes;
            }
          } else {
            notes.classList.add('hidden');
          }

          // Update the note slides
          currentSlide.contentWindow.postMessage(
            JSON.stringify({ method: 'setState', args: [data.state] }),
            '*'
          );
          upcomingSlide.contentWindow.postMessage(
            JSON.stringify({ method: 'setState', args: [data.state] }),
            '*'
          );
          upcomingSlide.contentWindow.postMessage(
            JSON.stringify({ method: 'next' }),
            '*'
          );
        }

        // Limit to max one state update per X ms
        handleStateMessage = debounce(handleStateMessage, 200);

        /**
         * Forward keyboard events to the current slide window.
         * This enables keyboard events to work even if focus
         * isn't set on the current slide iframe.
         *
         * Block F5 default handling, it reloads and disconnects
         * the speaker notes window.
         */
        function setupKeyboard() {
          document.addEventListener('keydown', function (event) {
            if (
              event.keyCode === 116 ||
              (event.metaKey && event.keyCode === 82)
            ) {
              event.preventDefault();
              return false;
            }
            currentSlide.contentWindow.postMessage(
              JSON.stringify({ method: 'triggerKey', args: [event.keyCode] }),
              '*'
            );
          });
        }

        /**
         * Creates the preview iframes.
         */
        function setupIframes(data) {
          var params = [
            'receiver',
            'progress=false',
            'history=false',
            'transition=none',
            'autoSlide=0',
            'backgroundTransition=none',
          ].join('&');

          var urlSeparator = /\?/.test(data.url) ? '&' : '?';
          var hash = '#/' + data.state.indexh + '/' + data.state.indexv;
          var currentURL =
            data.url + urlSeparator + params + '&postMessageEvents=true' + hash;
          var upcomingURL =
            data.url + urlSeparator + params + '&controls=false' + hash;

          currentSlide = document.createElement('iframe');
          currentSlide.setAttribute('width', 1280);
          currentSlide.setAttribute('height', 1024);
          currentSlide.setAttribute('src', currentURL);
          document.querySelector('#current-slide').appendChild(currentSlide);

          upcomingSlide = document.createElement('iframe');
          upcomingSlide.setAttribute('width', 640);
          upcomingSlide.setAttribute('height', 512);
          upcomingSlide.setAttribute('src', upcomingURL);
          document.querySelector('#upcoming-slide').appendChild(upcomingSlide);
        }

        /**
         * Setup the notes UI.
         */
        function setupNotes() {
          notes = document.querySelector('.speaker-controls-notes');
          notesValue = document.querySelector('.speaker-controls-notes .value');
        }

        /**
         * We send out a heartbeat at all times to ensure we can
         * reconnect with the main presentation window after reloads.
         */
        function setupHeartbeat() {
          setInterval(() => {
            window.opener.postMessage(
              JSON.stringify({ namespace: 'reveal-notes', type: 'heartbeat' }),
              '*'
            );
          }, 1000);
        }

        function getTimings(callback) {
          callRevealApi('getSlidesAttributes', [], function (slideAttributes) {
            callRevealApi('getConfig', [], function (config) {
              var totalTime = config.totalTime;
              var minTimePerSlide = config.minimumTimePerSlide || 0;
              var defaultTiming = config.defaultTiming;
              if (defaultTiming == null && totalTime == null) {
                callback(null);
                return;
              }
              // Setting totalTime overrides defaultTiming
              if (totalTime) {
                defaultTiming = 0;
              }
              var timings = [];
              for (var i in slideAttributes) {
                var slide = slideAttributes[i];
                var timing = defaultTiming;
                if (slide.hasOwnProperty('data-timing')) {
                  var t = slide['data-timing'];
                  timing = parseInt(t);
                  if (isNaN(timing)) {
                    console.warn(
                      "Could not parse timing '" +
                        t +
                        "' of slide " +
                        i +
                        '; using default of ' +
                        defaultTiming
                    );
                    timing = defaultTiming;
                  }
                }
                timings.push(timing);
              }
              if (totalTime) {
                // After we've allocated time to individual slides, we summarize it and
                // subtract it from the total time
                var remainingTime =
                  totalTime -
                  timings.reduce(function (a, b) {
                    return a + b;
                  }, 0);
                // The remaining time is divided by the number of slides that have 0 seconds
                // allocated at the moment, giving the average time-per-slide on the remaining slides
                var remainingSlides = timings.filter(function (x) {
                  return x == 0;
                }).length;
                var timePerSlide = Math.round(
                  remainingTime / remainingSlides,
                  0
                );
                // And now we replace every zero-value timing with that average
                timings = timings.map(function (x) {
                  return x == 0 ? timePerSlide : x;
                });
              }
              var slidesUnderMinimum = timings.filter(function (x) {
                return x < minTimePerSlide;
              }).length;
              if (slidesUnderMinimum) {
                message =
                  'The pacing time for ' +
                  slidesUnderMinimum +
                  ' slide(s) is under the configured minimum of ' +
                  minTimePerSlide +
                  ' seconds. Check the data-timing attribute on individual slides, or consider increasing the totalTime or minimumTimePerSlide configuration options (or removing some slides).';
                alert(message);
              }
              callback(timings);
            });
          });
        }

        /**
         * Return the number of seconds allocated for presenting
         * all slides up to and including this one.
         */
        function getTimeAllocated(timings, callback) {
          callRevealApi('getSlidePastCount', [], function (currentSlide) {
            var allocated = 0;
            for (var i in timings.slice(0, currentSlide + 1)) {
              allocated += timings[i];
            }
            callback(allocated);
          });
        }

        /**
         * Create the timer and clock and start updating them
         * at an interval.
         */
        function setupTimer() {
          var start = new Date(),
            timeEl = document.querySelector('.speaker-controls-time'),
            clockEl = timeEl.querySelector('.clock-value'),
            hoursEl = timeEl.querySelector('.hours-value'),
            minutesEl = timeEl.querySelector('.minutes-value'),
            secondsEl = timeEl.querySelector('.seconds-value'),
            pacingTitleEl = timeEl.querySelector('.pacing-title'),
            pacingEl = timeEl.querySelector('.pacing'),
            pacingHoursEl = pacingEl.querySelector('.hours-value'),
            pacingMinutesEl = pacingEl.querySelector('.minutes-value'),
            pacingSecondsEl = pacingEl.querySelector('.seconds-value'),
            startStopButton = document.querySelector('.start-stop-button');

          var timerState = 'not-started'; // 'not-started', 'running', 'stopped'
          var elapsedTime = 0; // milliseconds elapsed when stopped
          var timerInterval = null;

          var timings = null;
          getTimings(function (_timings) {
            timings = _timings;
            if (_timings !== null) {
              pacingTitleEl.style.removeProperty('display');
              pacingEl.style.removeProperty('display');
            }

            // Update once to show initial state
            _updateTimer();
          });

          function _startTimer() {
            if (timerState === 'not-started') {
              start = new Date();
              elapsedTime = 0;
            } else if (timerState === 'stopped') {
              // Resume from where we stopped
              start = new Date(new Date().getTime() - elapsedTime);
            }

            timerState = 'running';
            startStopButton.textContent = 'Stop';
            startStopButton.className = 'start-stop-button running';

            if (!timerInterval) {
              timerInterval = setInterval(_updateTimer, 1000);
            }
            _updateTimer();
          }

          function _stopTimer() {
            timerState = 'stopped';
            startStopButton.textContent = 'Resume';
            startStopButton.className = 'start-stop-button stopped';

            // Calculate elapsed time
            var now = new Date();
            elapsedTime = now.getTime() - start.getTime();

            if (timerInterval) {
              clearInterval(timerInterval);
              timerInterval = null;
            }
          }

          function _resetTimer() {
            // Stop the timer
            if (timerInterval) {
              clearInterval(timerInterval);
              timerInterval = null;
            }

            timerState = 'not-started';
            elapsedTime = 0;
            start = new Date();
            startStopButton.textContent = 'Start';
            startStopButton.className = 'start-stop-button';

            _updateTimer();
          }

          // Start/Stop button handler
          if (startStopButton) {
            startStopButton.addEventListener('click', function (e) {
              e.stopPropagation();
              if (timerState === 'running') {
                _stopTimer();
              } else {
                _startTimer();
              }
              return false;
            });
          }

          // Reset timer when clicking the reset button
          var resetButton = document.querySelector(
            '.subsection-label .reset-button'
          );
          if (resetButton) {
            resetButton.addEventListener('click', function (e) {
              e.stopPropagation();
              _resetTimer();
              return false;
            });
          }

          function _displayTime(hrEl, minEl, secEl, time) {
            var sign = Math.sign(time) == -1 ? '-' : '';
            time = Math.abs(Math.round(time / 1000));
            var seconds = time % 60;
            var minutes = Math.floor(time / 60) % 60;
            var hours = Math.floor(time / (60 * 60));
            hrEl.innerHTML = sign + zeroPadInteger(hours);
            if (hours == 0) {
              hrEl.classList.add('mute');
            } else {
              hrEl.classList.remove('mute');
            }
            minEl.innerHTML = ':' + zeroPadInteger(minutes);
            if (hours == 0 && minutes == 0) {
              minEl.classList.add('mute');
            } else {
              minEl.classList.remove('mute');
            }
            secEl.innerHTML = ':' + zeroPadInteger(seconds);
          }

          function _updateTimer() {
            var diff,
              hours,
              minutes,
              seconds,
              now = new Date();

            // Calculate elapsed time based on state
            if (timerState === 'not-started') {
              diff = 0;
            } else if (timerState === 'running') {
              diff = now.getTime() - start.getTime();
            } else if (timerState === 'stopped') {
              diff = elapsedTime;
            }

            clockEl.innerHTML = now.toLocaleTimeString('en-US', {
              hour12: true,
              hour: '2-digit',
              minute: '2-digit',
            });
            _displayTime(hoursEl, minutesEl, secondsEl, diff);
            if (timings !== null && timerState === 'running') {
              _updatePacing(diff);
            }
          }

          function _updatePacing(diff) {
            getTimeAllocated(timings, function (slideEndTimingSeconds) {
              var slideEndTiming = slideEndTimingSeconds * 1000;

              callRevealApi('getSlidePastCount', [], function (currentSlide) {
                var currentSlideTiming = timings[currentSlide] * 1000;
                var timeLeftCurrentSlide = slideEndTiming - diff;
                if (timeLeftCurrentSlide < 0) {
                  pacingEl.className = 'pacing behind';
                } else if (timeLeftCurrentSlide < currentSlideTiming) {
                  pacingEl.className = 'pacing on-track';
                } else {
                  pacingEl.className = 'pacing ahead';
                }
                _displayTime(
                  pacingHoursEl,
                  pacingMinutesEl,
                  pacingSecondsEl,
                  timeLeftCurrentSlide
                );
              });
            });
          }
        }

        /**
         * Sets up the speaker view layout and layout selector.
         */
        function setupLayout() {
          layoutDropdown = document.querySelector('.speaker-layout-dropdown');
          layoutLabel = document.querySelector('.speaker-layout-label');

          // Render the list of available layouts
          for (var id in SPEAKER_LAYOUTS) {
            var option = document.createElement('option');
            option.setAttribute('value', id);
            option.textContent = SPEAKER_LAYOUTS[id];
            layoutDropdown.appendChild(option);
          }

          // Monitor the dropdown for changes
          layoutDropdown.addEventListener(
            'change',
            function (event) {
              setLayout(layoutDropdown.value);
            },
            false
          );

          // Restore any currently persisted layout
          setLayout(getLayout());
        }

        /**
         * Sets a new speaker view layout. The layout is persisted
         * in local storage.
         */
        function setLayout(value) {
          var title = SPEAKER_LAYOUTS[value];

          layoutLabel.innerHTML = 'Layout' + (title ? ': ' + title : '');
          layoutDropdown.value = value;

          document.body.setAttribute('data-speaker-layout', value);

          // Persist locally
          if (supportsLocalStorage()) {
            window.localStorage.setItem('reveal-speaker-layout', value);
          }
        }

        /**
         * Returns the ID of the most recently set speaker layout
         * or our default layout if none has been set.
         */
        function getLayout() {
          if (supportsLocalStorage()) {
            var layout = window.localStorage.getItem('reveal-speaker-layout');
            if (layout) {
              return layout;
            }
          }

          // Default to wide layout
          return 'wide';
        }

        function supportsLocalStorage() {
          try {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            return true;
          } catch (e) {
            return false;
          }
        }

        function zeroPadInteger(num) {
          var str = '00' + parseInt(num);
          return str.substring(str.length - 2);
        }

        /**
         * Limits the frequency at which a function can be called.
         */
        function debounce(fn, ms) {
          var lastTime = 0,
            timeout;

          return function () {
            var args = arguments;
            var context = this;

            clearTimeout(timeout);

            var timeSinceLastCall = Date.now() - lastTime;
            if (timeSinceLastCall > ms) {
              fn.apply(context, args);
              lastTime = Date.now();
            } else {
              timeout = setTimeout(function () {
                fn.apply(context, args);
                lastTime = Date.now();
              }, ms - timeSinceLastCall);
            }
          };
        }
      })();
    </script>
  </body>
</html>
